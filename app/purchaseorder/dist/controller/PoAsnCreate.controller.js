sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox"],function(e,t){"use strict";return e.extend("sp.fiori.purchaseorder.controller.PoAsnCreate",{onInit:function(){this.oDataModel=sap.ui.getCore().getModel("oDataModel");this.getView().addStyleClass("sapUiSizeCompact");this.router=sap.ui.core.UIComponent.getRouterFor(this);this.router.attachRouteMatched(this.handleRouteMatched,this);this.asnModel=new sap.ui.model.json.JSONModel;this.asnModel.setSizeLimit(1e3);this.getView().setModel(this.asnModel,"asnModel");this.detailHeaderModel=new sap.ui.model.json.JSONModel;this.detailHeaderModel.setSizeLimit(1e3);this.getView().setModel(this.detailHeaderModel,"detailHeaderModel");this.flagModel=sap.ui.getCore().getModel("flagModel");var e=this.flagModel.getData();e.confirmPressFlag=false;this.flagModel.refresh(true);this.dateConfirmationModel=new sap.ui.model.json.JSONModel;this.getView().setModel(this.dateConfirmationModel,"DateConfirmationModel");this.popOverModel=new sap.ui.model.json.JSONModel;this.byId("uploadSet").attachEvent("openPressed",this.onOpenPressed,this)},handleRouteMatched:function(e){var a=this.getView().getModel();var o=this.byId("uploadSet");o.removeAllItems();if(e.getParameter("name")==="PoAsnCreate"){this.byId("rateOk").setSelected(true);this.modulePath=jQuery.sap.getModulePath("sp/fiori/purchaseorder");this.modulePath=this.modulePath==="."?"":this.modulePath;this.byId("totalInvNetAmnt").setValueState("None");this.byId("totalGstAmnt").setValueState("None");var r=this;var s=this.getView().byId("DP1");s.addDelegate({onAfterRendering:function(){s.$().find("INPUT").attr("disab1qled",true).css("color","#000000")}},s);var i=new Date;this.getView().byId("DP1").setMaxDate(i);var n=e.getParameter("arguments").Po_No;this.Po_Num=n.replace(/-/g,"/");this.Amount=e.getParameter("arguments").Amount;this.Vendor_No=e.getParameter("arguments").Vendor_No;var l=sessionStorage.getItem("unitCode")||"P01";this.AddressCodePO=sessionStorage.getItem("AddressCodePO")||"ATE-01-01";var a=this.getOwnerComponent().getModel();this.getView().byId("AsnCreateTable").removeSelections(true);var d="/PurchaseOrders";a.read(d,{urlParameters:{$expand:"DocumentRows",AddressCode:this.AddressCodePO,UnitCode:l,Po_Num:this.Po_Num},success:function(e){var a=e.results.find(e=>e.PoNum===r.Po_Num);if(a){r.asnModel.setData(a);r.asnModel.refresh(true);var o=r.getView().getModel("asnModel").getData();if(o.HasAttachments==="Invoice Submitted"){r.getHeaderDetails()}}else{t.error("Purchase order not found")}},error:function(e){var a=JSON.parse(e.response.body);t.error(a.error.message.value)}});sap.ui.core.BusyIndicator.hide()}},getHeaderDetails:function(){var e=this;var a=this.getView().getModel();a.read("/ASNListHeader",{success:function(a){let o=e.Po_Num.replace(/\//g,"-");var r=a.results.find(e=>e.PNum_PoNum===o);if(r){var s=e.getView().getModel("asnModel").getData();s.BillNumber=r.BillNumber;s.BillDate=r.BillDate;s.DocketNumber=r.DocketNumber;s.GRDate=r.GRDate;s.TransportName=r.TransportName;s.TransportMode=r.TransportMode;s.EwayBillNumber=r.EwayBillNumber;s.EwayBillDate=r.EwayBillDate;s.MillNumber=r.MillNumber;s.MillName=r.MillName;s.PDIRNumber=r.PDIRNumber;s.HeatNumber=r.HeatNumber;s.BatchNumber=r.BatchNumber;s.ManufacturingMonth=r.ManufacturingMonth;e.asnModel.refresh(true);e._fetchFilesForPoNum(o);e.detailHeaderModel.refresh(true)}else{t.error("Purchase order not found")}}.bind(this),error:function(e){var a=JSON.parse(e.response.body);t.error(a.error.message.value)}.bind(this)})},_fetchFilesForPoNum:function(e){var t=this.getView().getModel();var a=this.byId("uploadSet");a.removeAllItems();t.read("/Files",{filters:[new sap.ui.model.Filter("PNum_PoNum",sap.ui.model.FilterOperator.EQ,e)],success:function(e){e.results.forEach(function(e){var t=new sap.m.upload.UploadSetItem({fileName:e.fileName,mediaType:e.mediaType,url:e.url,attributes:[new sap.m.ObjectAttribute({title:"Uploaded By",text:e.createdBy}),new sap.m.ObjectAttribute({title:"Uploaded on",text:e.createdAt}),new sap.m.ObjectAttribute({title:"File Size",text:e.size.toString()})]});a.addItem(t)})},error:function(e){console.log("Error: "+e)}})},onNavBack:function(){history.go(-1)},onAsnSaveDB:function(){var e=this.getOwnerComponent().getModel();this.data=this.asnModel.getData();var a={PNum_PoNum:this.data.PoNum.replace(/\//g,"-"),AsnNum:this.data.AsnNum,BillDate:this.data.BillDate,BillNumber:this.data.BillNumber,DocketNumber:this.data.DocketNumber,GRDate:this.data.GRDate,TransportName:this.data.TransportName,TransportMode:this.data.TransportMode,EwayBillNumber:this.data.EwayBillNumber,EwayBillDate:this.data.EwayBillDate,MillNumber:this.data.MillNumber,MillName:this.data.MillName,PDIRNumber:this.data.PDIRNumber,HeatNumber:this.data.HeatNumber,BatchNumber:this.data.BatchNumber,ManufacturingMonth:this.data.ManufacturingMonth,PlantName:this.data.PlantName,PlantCode:this.data.PlantCode,VendorCode:this.data.VendorCode,TotalInvNetAmnt:this.data.TotalInvNetAmnt,TotalGstAmnt:this.data.TotalGstAmnt,RateStatus:this.data.DocumentRows.results.every(e=>e.RateAgreed===true)?"Rate Matched":"Rate Un-Matched"};if(!a.BillNumber){t.error("Please fill the Invoice Number");return}else if(!a.BillDate){t.error("Please fill the Invoice Date");return}if(!a.TotalInvNetAmnt){t.error("Please fill Total Invoice Net Amount");return}else if(!a.TotalGstAmnt){t.error("Please fill Total GST Amount");return}if(this.getView().byId("uploadSet").getItems().length<=0){t.error("Please upload invoice.");return}e.create("/ASNListHeader",a,{success:()=>{const e=JSON.stringify(this.data.DocumentRows.results.map(e=>{delete e.__metadata;return e}));const a={async:true,url:this.modulePath+"/po/odata/v4/catalog/stageDocumentRows",method:"POST",headers:{"content-type":"application/json"},processData:false,data:JSON.stringify({data:e})};$.ajax(a).done(()=>{t.success("Invoice submitted successfully.",{onClose:()=>sp.fiori.purchaseorder.controller.formatter.onNavBack()})})},error:function(e){t.error("Error submitting invoice: "+e.message)}})},onAsnCancel:function(){this.router.navTo("PoMaster")},onAfterItemAdded:function(e){let t=e.getParameter("item");let a=this.Po_Num.replace(/\//g,"-");this._createEntity(t,a).then(()=>{this._uploadContent(t,a)}).catch(e=>{console.log("Error: "+e)})},onUploadCompleted:function(e){var t=this.byId("uploadSet");var a=e.getParameter("item");var o=a.getUploadUrl();var r=o;a.setUrl(r);t.getBinding("items").refresh();t.invalidate()},_createEntity:function(e,t){var a=this.getView().getModel();var o={PNum_PoNum:t,mediaType:e.getMediaType(),fileName:e.getFileName(),size:e.getFileObject().size,url:"https://impautosuppdev.launchpad.cfapps.ap10.hana.ondemand.com/547b58c0-9667-470f-a767-c8524482b3ed.PO.spfioripurchaseorder-0.0.1"+`/po/odata/v4/catalog/Files(PNum_PoNum='${t}')/content`};return new Promise((e,t)=>{a.create("/Files",o,{success:function(){e()},error:function(e){console.log("Error: ",e);t(e)}})})},_uploadContent:function(e,t){var a="https://impautosuppdev.launchpad.cfapps.ap10.hana.ondemand.com/547b58c0-9667-470f-a767-c8524482b3ed.PO.spfioripurchaseorder-0.0.1"+`/po/odata/v4/catalog/Files(PNum_PoNum='${t}')/content`;e.setUploadUrl(a);var o=this.byId("uploadSet");o.setHttpRequestMethod("PUT");o.uploadItem(e)},onOpenPressed:function(e){e.preventDefault();var t=e.getParameter("item");this._fileName=t.getFileName();this._download(t).then(e=>{var t=window.URL.createObjectURL(e);var a=document.createElement("a");a.href=t;a.setAttribute("download",this._fileName);document.body.appendChild(a);a.click();document.body.removeChild(a)}).catch(e=>{console.log(e)})},_download:function(e){console.log("_download");var t={url:e.getUrl(),method:"GET",xhrFields:{responseType:"blob"}};return new Promise((e,a)=>{$.ajax(t).done((t,a,o)=>{e(t)}).fail(e=>{a(e)})})},onTypeMissmatch:function(e){t.error("Only PDF files are allowed.")},onInvNoChange:function(e){if(e.getParameter("value")===""){this.getView().byId("DP1").setEnabled(false);this.getView().byId("DP1").setValue("")}else{this.getView().byId("DP1").setEnabled(true)}},onRateOkChange:function(e){const t=e.getParameter("selected");this.asnModel.getData().DocumentRows.results.forEach(e=>{e.RateAgreed=t});this.asnModel.refresh(true)},onRateAgreedChange:function(e){const t=e.getParameter("selected");if(t){e.getSource().getBindingContext("asnModel").getObject().SupplierRate=0}this.asnModel.refresh(true)},onTotalChange:function(){let e,t=0,a=0;this.byId("AsnCreateTable").getItems().forEach(o=>{e=o.getBindingContext("asnModel").getObject();t+=parseFloat(e.PoQty)*parseFloat(e.UnitPrice);a+=parseFloat(e.IGST)+parseFloat(e.CGST)+parseFloat(e.SGST)});const o=this.byId("totalInvNetAmnt"),r=this.byId("totalGstAmnt");if(t===parseFloat(o.getValue())){o.setValueState("Success")}else{o.setValueState("Warning").setValueStateText("Amount Mismatch")}if(a===parseFloat(r.getValue())){r.setValueState("Success")}else{r.setValueState("Warning").setValueStateText("Amount Mismatch")}}})});