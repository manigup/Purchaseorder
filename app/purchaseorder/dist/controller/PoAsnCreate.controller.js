sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox"],function(e,t){"use strict";return e.extend("sp.fiori.purchaseorder.controller.PoAsnCreate",{onInit:function(){this.oDataModel=sap.ui.getCore().getModel("oDataModel");this.getView().addStyleClass("sapUiSizeCompact");this.router=sap.ui.core.UIComponent.getRouterFor(this);this.router.attachRouteMatched(this.handleRouteMatched,this);this.asnModel=new sap.ui.model.json.JSONModel;this.asnModel.setSizeLimit(1e3);this.getView().setModel(this.asnModel,"asnModel");this.detailHeaderModel=new sap.ui.model.json.JSONModel;this.detailHeaderModel.setSizeLimit(1e3);this.getView().setModel(this.detailHeaderModel,"detailHeaderModel");this.flagModel=sap.ui.getCore().getModel("flagModel");var e=this.flagModel.getData();e.confirmPressFlag=false;this.flagModel.refresh(true);this.dateConfirmationModel=new sap.ui.model.json.JSONModel;this.getView().setModel(this.dateConfirmationModel,"DateConfirmationModel");this.popOverModel=new sap.ui.model.json.JSONModel;this.byId("uploadSet").attachEvent("openPressed",this.onOpenPressed,this)},handleRouteMatched:function(e){if(e.getParameter("name")==="PoAsnCreate"){var a=this.getView().getModel();var o=this.byId("uploadSet");o.removeAllIncompleteItems();this.modulePath=jQuery.sap.getModulePath("sp/fiori/purchaseorder");this.modulePath=this.modulePath==="."?"":this.modulePath;this.byId("totalInvNetAmnt").setValueState("None");this.byId("totalCGstAmnt").setValueState("None");this.byId("totalSGstAmnt").setValueState("None");this.byId("totalIGstAmnt").setValueState("None");this.byId("totalAmnt").setValueState("None");this.byId("ewayBillNumberId").setValueState("None");var s=this;var r=this.getView().byId("DP1");r.addDelegate({onAfterRendering:function(){r.$().find("INPUT").attr("disab1qled",true).css("color","#000000")}},r);var i=new Date;this.getView().byId("DP1").setMaxDate(i);var l=e.getParameter("arguments").Po_No;this.Po_Num=l.replace(/-/g,"/");this.Amount=e.getParameter("arguments").Amount;this.Vendor_No=e.getParameter("arguments").Vendor_No;var n=e.getParameter("arguments").UnitCode||"P01";this.AddressCodePO=sessionStorage.getItem("AddressCodePO")||"JSE-01-01";var a=this.getOwnerComponent().getModel();this.getView().byId("AsnCreateTable").removeSelections(true);var d="/PurchaseOrders";a.read(d,{urlParameters:{$expand:"DocumentRows",AddressCode:this.AddressCodePO,UnitCode:n,Po_Num:this.Po_Num},success:function(e){var a=e.results.find(e=>e.PoNum===s.Po_Num);if(a){s.asnModel.setData(a);s.asnModel.refresh(true);var o=s.getView().getModel("asnModel").getData();if(o.HasAttachments==="Invoice Submitted"){s.getHeaderDetails()}s.GetTransportModeList()}else{t.error("Purchase order not found")}},error:function(e){var a=JSON.parse(e.response.body);t.error(a.error.message.value)}});sap.ui.core.BusyIndicator.hide()}},GetTransportModeList:function(){var e=this.getView().getModel();return new Promise(function(t,a){e.callFunction("/GetTransportModeList",{method:"GET",success:function(e,a){var o=e.results;var s=new sap.ui.model.json.JSONModel;s.setData({items:o});this.getView().setModel(s,"transport");t()}.bind(this),error:function(e){a(new Error("Failed to fetch transport data."))}})}.bind(this))},getHeaderDetails:function(){var e=this;var a=this.getView().getModel();a.read("/ASNListHeader",{success:function(a){let o=e.Po_Num.replace(/\//g,"-");var s=a.results.find(e=>e.PNum_PoNum===o);if(s){var r=e.getView().getModel("asnModel").getData();r.BillNumber=s.BillNumber;r.BillDate=s.BillDate;r.DocketNumber=s.DocketNumber;r.GRDate=s.GRDate;r.TransportName=s.TransportName;r.TransportMode=s.TransportMode;r.EwayBillNumber=s.EwayBillNumber;r.EwayBillDate=s.EwayBillDate;r.MillNumber=s.MillNumber;r.MillName=s.MillName;r.PDIRNumber=s.PDIRNumber;r.HeatNumber=s.HeatNumber;r.BatchNumber=s.BatchNumber;r.ManufacturingMonth=s.ManufacturingMonth;r.TotalInvNetAmnt=s.TotalInvNetAmnt;r.TotalCGstAmnt=s.TotalCGstAmnt;r.TotalSGstAmnt=s.TotalSGstAmnt;r.TotalIGstAmnt=s.TotalIGstAmnt;r.TotalAmnt=s.TotalAmnt;r.TransporterID=s.TransporterID;e.asnModel.refresh(true);e._fetchFilesForPoNum(o,r.BillNumber);e.detailHeaderModel.refresh(true)}else{t.error("Purchase order not found")}}.bind(this),error:function(e){var a=JSON.parse(e.response.body);t.error(a.error.message.value)}.bind(this)})},_fetchFilesForPoNum:function(e,t){var a=this.getView().getModel();var o=this.byId("uploadSet");o.removeAllItems();a.read("/Files",{filters:[new sap.ui.model.Filter("PNum_PoNum",sap.ui.model.FilterOperator.EQ,e),new sap.ui.model.Filter("Ref_Inv",sap.ui.model.FilterOperator.EQ,t)],success:function(e){e.results.forEach(function(e){var t=new sap.m.upload.UploadSetItem({fileName:e.fileName,mediaType:e.mediaType,url:e.url,attributes:[new sap.m.ObjectAttribute({title:"Uploaded By",text:e.createdBy}),new sap.m.ObjectAttribute({title:"Uploaded on",text:e.createdAt}),new sap.m.ObjectAttribute({title:"File Size",text:e.size.toString()})]});o.addItem(t)})},error:function(e){console.log("Error: "+e)}})},onNavBack:function(){history.go(-1)},onAsnSaveDB:function(){if(this.validateFields()){var e=this.getOwnerComponent().getModel();this.data=this.asnModel.getData();var a={PNum_PoNum:this.data.PoNum.replace(/\//g,"-"),AsnNum:this.data.AsnNum,BillDate:this.data.BillDate,BillNumber:this.data.BillNumber,DocketNumber:this.data.DocketNumber,GRDate:this.data.GRDate,TransportName:this.data.TransportName,TransportMode:this.data.TransportMode,EwayBillNumber:this.data.EwayBillNumber,EwayBillDate:this.data.EwayBillDate,MillNumber:this.data.MillNumber,MillName:this.data.MillName,PDIRNumber:this.data.PDIRNumber,HeatNumber:this.data.HeatNumber,BatchNumber:this.data.BatchNumber,ManufacturingMonth:this.data.ManufacturingMonth,PlantName:this.data.PlantName,PlantCode:this.data.PlantCode,VendorCode:this.data.VendorCode,TotalInvNetAmnt:this.data.TotalInvNetAmnt,TotalCGstAmnt:this.data.TotalCGstAmnt,TotalSGstAmnt:this.data.TotalSGstAmnt,TotalIGstAmnt:this.data.TotalIGstAmnt,TotalAmnt:this.data.TotalAmnt,TransporterID:this.data.TransporterID};var o=this.getView().byId("AsnCreateTable");var s=o.getSelectedItems();if(!a.BillNumber){t.error("Please fill the Invoice Number");return}else if(!a.BillDate){t.error("Please fill the Invoice Date");return}if(this.getView().byId("uploadSet").getIncompleteItems().length<=0){t.error("Please upload invoice.");return}if(!s.length){t.error("No Item Selected");return}let r,i;i=s.some(e=>{r=e.getBindingContext("asnModel").getObject();return parseInt(r.InvBalQty)===0});if(i){t.error("Please unselect item with balanced qty 0 to proceed");return}e.create("/ASNListHeader",a,{success:()=>{let e,a,o,r,i=[];const l=JSON.stringify(s.map(t=>{e=t.getBindingContext("asnModel").getObject();if(parseInt(e.InvBalQty)>0){a=parseInt(e.PoQty);o=parseInt(e.InvBalQty)===0?a:parseInt(e.InvBalQty)+parseInt(e.InvQty);r=a-o;i.push({REF_INV:this.data.BillNumber,Item_Code:e.ItemCode,Po_Num:e.PNum_PoNum,INVOICE_DATE:this.data.BillDate,INVOICE_AMT:this.data.TotalAmnt,IGST_AMT:this.data.TotalInvNetAmnt,CGST_AMT:this.data.TotalCGstAmnt,SGST_AMT:this.data.TotalSGstAmnt,Po_Qty:a,Inv_Qty:o,InvBal_Qty:r,INV_DELETE:false});delete e.__metadata;delete e.PNum;e.InvQty=o;e.InvBalQty=r;return e}}));let n={async:true,url:this.modulePath+"/po/odata/v4/catalog/stageDocumentRows",method:"POST",headers:{"content-type":"application/json"},processData:false,data:JSON.stringify({data:l})};$.ajax(n).done(()=>{n={async:true,url:this.modulePath+"/po/odata/v4/catalog/stageInvHeaderList",method:"POST",headers:{"content-type":"application/json"},processData:false,data:JSON.stringify({data:JSON.stringify(i)})};$.ajax(n).done(()=>{this._createEntity(this.uploadItem,this.data.PoNum.replace(/\//g,"-"),this.data.BillNumber).then(()=>{this._uploadContent(this.uploadItem,this.data.PoNum.replace(/\//g,"-"),this.data.BillNumber)}).catch(e=>{console.log("Error: "+e)});t.success("Invoice submitted successfully.",{onClose:()=>sp.fiori.purchaseorder.controller.formatter.onNavBack()})})})},error:e=>{const a=e.response.body;if(a.indexOf("<?xml")!==-1){t.error($($.parseXML(a)).find("message").text())}else{t.error(JSON.parse(a).error.message.value)}}})}else{t.error("Please fill correct Eway Bill Number");return}},onAsnCancel:function(){this.router.navTo("PoMaster")},onAfterItemAdded:function(e){this.uploadItem=e.getParameter("item");e.getParameter("item").setVisibleEdit(false).setVisibleRemove(false)},_createEntity:function(e,t,a){var o=this.getView().getModel();this.hardcodedURL="";if(window.location.href.includes("site")){this.hardcodedURL=jQuery.sap.getModulePath("sp.fiori.purchaseorder")}var s={PNum_PoNum:t,Ref_Inv:a,mediaType:e.getMediaType(),fileName:e.getFileName(),size:e.getFileObject().size,url:this.hardcodedURL+`/po/odata/v4/catalog/Files(PNum_PoNum='${t}',Ref_Inv='${a}')/content`};return new Promise((e,t)=>{o.create("/Files",s,{success:function(){e()},error:function(e){console.log("Error: ",e);t(e)}})})},_uploadContent:function(e,t,a){this.hardcodedURL="";if(window.location.href.includes("site")){this.hardcodedURL=jQuery.sap.getModulePath("sp.fiori.purchaseorder")}var o=this.hardcodedURL+`/po/odata/v4/catalog/Files(PNum_PoNum='${t}',Ref_Inv='${a}')/content`;e.setUploadUrl(o);var s=this.byId("uploadSet");s.setHttpRequestMethod("PUT");s.uploadItem(e)},onOpenPressed:function(e){e.preventDefault();var t=e.getParameter("item");this._fileName=t.getFileName();this._download(t).then(e=>{var t=window.URL.createObjectURL(e);var a=document.createElement("a");a.href=t;a.setAttribute("download",this._fileName);document.body.appendChild(a);a.click();document.body.removeChild(a)}).catch(e=>{console.log(e)})},_download:function(e){console.log("_download");var t={url:e.getUrl(),method:"GET",xhrFields:{responseType:"blob"}};return new Promise((e,a)=>{$.ajax(t).done((t,a,o)=>{e(t)}).fail(e=>{a(e)})})},onTypeMissmatch:function(e){t.error("Only PDF files are allowed.")},onRateOkChange:function(e){const t=e.getParameter("selected");this.asnModel.getData().DocumentRows.results.forEach(e=>{e.RateAgreed=t});this.asnModel.refresh(true)},onRateAgreedChange:function(e){const t=e.getParameter("selected");if(t){e.getSource().getBindingContext("asnModel").getObject().SupplierRate=0}this.asnModel.refresh(true)},onRowSelect:function(){let e,t=0,a=0,o=0,s=0,r=0;this.byId("AsnCreateTable").getSelectedItems().forEach(i=>{e=i.getBindingContext("asnModel").getObject();t+=parseFloat(e.PoQty)*parseFloat(e.UnitPrice);if(parseFloat(e.CGST)!==0){a+=parseFloat(e.CGST)*parseFloat(e.PoQty)*parseFloat(e.UnitPrice)/100}if(parseFloat(e.SGST)!==0){o+=parseFloat(e.SGST)*parseFloat(e.PoQty)*parseFloat(e.UnitPrice)/100}if(parseFloat(e.IGST)!==0){s+=parseFloat(e.IGST)*parseFloat(e.PoQty)*parseFloat(e.UnitPrice)/100}r=t+a+o+s});const i=this.byId("totalInvNetAmnt"),l=this.byId("totalCGstAmnt"),n=this.byId("totalSGstAmnt"),d=this.byId("totalIGstAmnt"),u=this.byId("totalAmnt");i.setValue(parseFloat(this.formatAmnt(t)));l.setValue(parseFloat(this.formatAmnt(a)));n.setValue(parseFloat(this.formatAmnt(o)));d.setValue(parseFloat(this.formatAmnt(s)));u.setValue(parseFloat(this.formatAmnt(r)));if(t===parseFloat(i.getValue())){i.setValueState("Success").setValueStateText("Amount Matched")}else{i.setValueState("Warning").setValueStateText("Amount Mismatch")}if(a===parseFloat(l.getValue())){l.setValueState("Success").setValueStateText("Amount Matched")}else{l.setValueState("Warning").setValueStateText("Amount Mismatch")}if(o===parseFloat(n.getValue())){n.setValueState("Success").setValueStateText("Amount Matched")}else{n.setValueState("Warning").setValueStateText("Amount Mismatch")}if(s===parseFloat(d.getValue())){d.setValueState("Success").setValueStateText("Amount Matched")}else{d.setValueState("Warning").setValueStateText("Amount Mismatch")}if(r===parseFloat(u.getValue())){u.setValueState("Success").setValueStateText("Amount Matched")}else{u.setValueState("Warning").setValueStateText("Amount Mismatch")}},validateFields:function(){var e=true,t=this.getView().byId("ewayBillNumberId"),a=t.getBinding("value");if(t.getValue()){try{a.getType().validateValue(t.getValue());t.setValueState("None");e=true}catch(a){t.setValueState("Error");e=false}}return e},formatAmnt:function(e){if(e){var t=sap.ui.core.format.NumberFormat.getFloatInstance({groupingEnabled:false,groupingSeparator:"",groupingSize:0,decimalSeparator:".",decimals:2});return t.format(e)}return"0.00"}})});