sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox"],function(e,t){"use strict";return e.extend("sp.fiori.purchaseorder.controller.PoAsnEdit",{onInit:function(){this.oDataModel=sap.ui.getCore().getModel("oDataModel");this.getView().setModel(this.oDataModel);this.getView().addStyleClass("sapUiSizeCompact");this.router=sap.ui.core.UIComponent.getRouterFor(this);this.router.attachRouteMatched(this.handleRouteMatched,this);this.asnModel=new sap.ui.model.json.JSONModel;this.asnModel.setSizeLimit(1e3);this.getView().setModel(this.asnModel,"asnModel");this.flagModel=sap.ui.getCore().getModel("flagModel");var e=this.flagModel.getData();e.confirmPressFlag=false;this.flagModel.refresh(true);this.DeleteArray=[];this.DeleteFlag=false;this.uploadCollectionTemp=this.getView().byId("UploadCollItemId").clone();this.dateConfirmationModel=new sap.ui.model.json.JSONModel;this.getView().setModel(this.dateConfirmationModel,"DateConfirmationModel");this.popOverModel=new sap.ui.model.json.JSONModel},handleRouteMatched:function(e){if(e.getParameter("name")==="PoAsnEdit"){var a=this;var r=this.getView().byId("DP1");r.addDelegate({onAfterRendering:function(){r.$().find("INPUT").attr("disabled",true).css("color","#000000")}},r);var n=new Date;var o=new Date;var s=new Date;s.setDate(n.getDate()-4);o.setDate(n.getDate()+1);this.getView().byId("DP1").setMinDate(s);this.getView().byId("DP1").setMaxDate(n);this.Po_Num=e.getParameter("arguments").Po_No;this.Amount=e.getParameter("arguments").Amount;this.Amount.trim();this.Vendor_No=e.getParameter("arguments").Vendor_No;this.Asn_No=e.getParameter("arguments").Asn_No;this.FisYear=this.getOwnerComponent().getComponentData().startupParameters.FisYear[0];this.getView().byId("AsnObjectId").setTitle("ASN Number:"+this.Asn_No+"/"+this.FisYear+"");this.getView().byId("AsnCreateTable").removeSelections(true);this.oDataModel.read("/PO_ASN_HEADERSet(Po_No='"+this.Po_Num+"')?$expand=asnheadertoasnitemnav",null,null,false,function(e,t){var r=jQuery.sap.storage(jQuery.sap.storage.Type.session).get("AsnItems");var n=e.asnheadertoasnitemnav.results;n.forEach(function(e){r.forEach(function(t){if(e.Ebelp===t.ItemNo.trim()&&parseInt(e.Etenr)===parseInt(t.schd_line)){e.Draft_AsnQty=t.Quantity;e.Draft_AsnQty1=t.Quantity}});if(e.Draft_AsnQty!=="0"){e.Selected=true;e.CheckFlag="X"}});let o;e.asnheadertoasnitemnav.results=n.filter(function(e){o=parseFloat(e.Draft_AsnQty)/parseFloat(e.SOQ);e.PkgMatQty=isNaN(o)?"0":isFinite(o)===false?"0":Math.ceil(o).toString();return e.Menge!=="0.00"||e.Draft_AsnQty!=="0"});a.asnModel.setData(e);a.asnModel.getData().InvoiceAmt=a.Amount;a.asnModel.getData().InvoiceNum=a.getOwnerComponent().getComponentData().startupParameters.Invoice_Num[0];a.asnModel.getData().InvoiceDate=a.getOwnerComponent().getComponentData().startupParameters.Invoice_Date[0];if(jQuery.sap.storage(jQuery.sap.storage.Type.session).get("UnplannedCost")){a.asnModel.getData().UnplannedCost=jQuery.sap.storage(jQuery.sap.storage.Type.session).get("UnplannedCost").trim();var s=+a.asnModel.getData().InvoiceAmt+ +a.asnModel.getData().UnplannedCost;a.asnModel.getData().InvoiceVal=s.toFixed(2);a.getView().byId("AsnObjectId").setNumber(a.asnModel.getData().InvoiceVal)}a.asnModel.refresh(true)},function(e){var a=JSON.parse(e.response.body);t.error(a.error.message.value)});sap.ui.core.BusyIndicator.hide();if(!this.header_xcsrf_token){var i=this.getView().getModel();var l=i.sServiceUrl+"/";var a=this;sap.ui.core.BusyIndicator.show(0);i._request({requestUri:l,method:"GET",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/atom+xml",DataServiceVersion:"2.0","X-CSRF-Token":"Fetch"}},function(e,t){sap.ui.core.BusyIndicator.hide();a.header_xcsrf_token=t.headers["x-csrf-token"]});sap.ui.core.BusyIndicator.hide()}sap.ui.core.BusyIndicator.hide();this.getView().byId("UploadCollection").bindItems({path:"/AsnAttachementSet?$filter=AsnNum eq '"+this.Asn_No+"' and FisYear eq '"+this.FisYear+"'",template:a.uploadCollectionTemp})}},onPrint:function(){var e=document.createElement("a");e.href="/sap/fiori/sppurchaseorder/model/Print.pdf";var t=decodeURIComponent("Print.pdf");e.download=t;document.body.appendChild(e);e.click();e.remove()},onUnplannedCostChange:function(e){if(e.getParameter("newValue").includes("-")){t.error("Unplanned cost less than 0 is not allowed!");var a=Math.abs(parseFloat(e.getParameter("newValue")));e.getSource().setValue(a)}if(e.getParameter("newValue").includes(".")){var r=e.getParameter("newValue").split(".");if(r[1].length>2){t.error("Value upto 2 decimals is allowed.");e.getSource().setValue(parseFloat(e.getParameter("newValue")).toFixed(2))}}},onQuanChange:function(e){this.calculateInvoiceAmt()},onNavBack:function(){var e=this.getOwnerComponent().getComponentData();if(e!==undefined&&e.startupParameters.ASN_NO){var t=sap.ushell.Container.getService("CrossApplicationNavigation");t.toExternal({target:{semanticObject:"asn",action:"manage"},params:{Asn_Num:e.startupParameters.ASN_NO[0]}})}else{this.router.navTo("PoMaster")}},onAsnUpdate:function(e){var a=this.getView().byId("AsnCreateTable").getItems();var r=a.map(function(e){return e.getBindingContext("asnModel").getObject()});var n=JSON.parse(JSON.stringify(r));var o=this;this.data=this.asnModel.getData();var s={Update:true,Delete:this.DeleteFlag,AsnNum:this.Asn_No,Fis_Year:this.FisYear,Buyer_Name:this.data.Buyer_Name,Currency:this.data.Currency,InvoiceAmt:this.data.InvoiceAmt.toString(),InvoiceVal:this.data.InvoiceVal.toString(),UnplannedCost:this.data.UnplannedCost.toString(),UnplannedCost_text:this.data.UnplannedCost_text,InvoiceDate:this.data.InvoiceDate,InvoiceNum:this.data.InvoiceNum,Po_No:this.data.Po_No,Purchase_Group_Desc:this.data.Purchase_Group_Desc,ShipTime:this.data.ShipTime,Total_Amount:this.data.Total_Amount.toString(),Vendor_No:this.data.Vendor_No,Werks:this.data.Werks,asnheadertoasnitemnav:[]};s.Total_Amount=this.Amount;s.Vendor_No=this.Vendor_No;if(this.data.InvoiceNum){s.DraftAsn=false;if(this.getView().byId("UploadCollection").getItems().length<=0){t.error("Atleast One attachment is required.");return}}else{s.DraftAsn=true}var i=this.getView().byId("AsnCreateTable");var l=i.getSelectedContexts();if(!s.InvoiceAmt){t.error("Please fill all the required Information");return}else if(!l.length){t.error("No Item Selected");return}else{var d=l.map(function(e){return e.getObject()});for(var u=0;u<d.length;u++){if(!d[u].Draft_AsnQty){t.error("Draft ASN Quantity is required for selected items");sap.ui.core.BusyIndicator.hide();return}else{s.asnheadertoasnitemnav.push(d[u])}}var c=[];var h=s.asnheadertoasnitemnav;h.forEach(function(e){e.Draft_AsnQty1=e.Draft_AsnQty1?e.Draft_AsnQty1:0;var a=+e.Asn_Created-+e.Draft_AsnQty1;var r=+e.Draft_AsnQty+a;if(parseFloat(e.Total_Qty)<r){t.error("Draft ASN Quantity cannot be greater then ASN to be Created");c.push(true)}else{c.push(false)}});if(c.every(e=>e!==true)){var g=s.asnheadertoasnitemnav;g.forEach(function(e){if(e.Selected){delete e.Draft_AsnQty1;delete e.Selected;delete e.CheckFlag}});o.oDataModel.create("/PO_ASN_HEADERSet",s,null,function(e,a){o.asn=e.AsnNum;o.year=e.Fis_Year;var r=e.AsnNum+"/"+e.Fis_Year;o.onStartUpload();t.success("ASN "+e.AsnNum+"/"+e.Fis_Year+" updated succesfully  ",{actions:[sap.m.MessageBox.Action.OK],icon:sap.m.MessageBox.Icon.SUCCESS,title:"Success",onClose:function(e){if(e==="OK"){o.onNavBack()}}})},function(e){var r=o.asnModel.getData();r.asnheadertoasnitemnav.results=n;o.asnModel.setData(r);g=a;try{var s=JSON.parse(e.response.body);t.error(s.error.message.value)}catch(a){var i=jQuery.parseXML(e.getParameter("responseText")).querySelector("message").textContent;t.error(i)}})}}},handleLinkPress:function(e){if(!this._oPopover){this._oPopover=sap.ui.xmlfragment("sp.fiori.purchaseorder.fragment.PricePopoverFragment",this);this.getView().addDependent(this._oPopover)}var t=e.getSource().getBindingContext("asnModel").sPath;var a=this.asnModel.getProperty(t);this.popOverModel.setData(a);this._oPopover.setModel(this.popOverModel);this._oPopover.openBy(e.getSource())},onAsnCancel:function(){this.router.navTo("PoMaster")},onChange:function(e){var t=e.getSource();if(this.header_xcsrf_token){var a=new sap.m.UploadCollectionParameter({name:"x-csrf-token",value:this.header_xcsrf_token});t.addHeaderParameter(a)}},onStartUpload:function(e){var t=this.getView().byId("UploadCollection");t.upload()},onBeforeUploadStarts:function(e){var t=new sap.m.UploadCollectionParameter({name:"slug",value:this.asn+"/"+this.year+"/"+e.getParameter("fileName")});e.getParameters().addHeaderParameter(t)},onSelectionChange:function(e){var t=this.getView().byId("AsnCreateTable").getItems();for(var a=0;a<t.length;a++){var r=t[a].getBindingContext("asnModel").getObject();if(r.CheckFlag=="X"){t[a].setSelected(true)}}this.draftInvoiceAmt()},calculateInvoiceAmt:function(){var e=this.asnModel.getData();e.InvoiceAmt=0;var t=this.getView().byId("AsnCreateTable");var a=t.getSelectedContexts();if(a.length){var r=a.map(function(e){return e.getObject()});for(var n=0;n<r.length;n++){var o=parseFloat(r[n].Menge);if(o<0||r[n].Menge.includes("-")){sap.m.MessageBox.error("Quantity can't be in negative.");sap.ui.core.BusyIndicator.hide();return}if(!r[n].Menge){sap.m.MessageBox.error("Please enter a valid Quantity for selected items");e.InvoiceAmt=0;break}var s=(parseFloat(r[n].Menge)*parseFloat(r[n].Netpr)).toFixed(2);var i=(parseFloat(r[n].Menge)*parseFloat(r[n].Cgst)).toFixed(2);var l=(parseFloat(r[n].Menge)*parseFloat(r[n].Igst)).toFixed(2);var d=(parseFloat(r[n].Menge)*parseFloat(r[n].Sgst)).toFixed(2);e.InvoiceAmt=parseFloat(e.InvoiceAmt)+parseFloat(s)+parseFloat(i)+parseFloat(l)+parseFloat(d);e.InvoiceAmt=parseFloat(e.InvoiceAmt).toFixed(2);e.InvoiceAmt=Math.round(e.InvoiceAmt)}}this.asnModel.refresh(true)},onDateFilter:function(e){var a=this.byId("FromDateId").getValue();var r=this.byId("ToDateId").getValue();var n=this.getView().byId("AsnCreateTable").getBinding("items");if(a||r){var o=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter({path:"Eindt",operator:sap.ui.model.FilterOperator.LE,value1:r}),new sap.ui.model.Filter({path:"Eindt",operator:sap.ui.model.FilterOperator.GE,value1:a})],and:true});n.filter(o)}else{t.error("No Dates are Selected")}},onDeliveryCost:function(e){var t=this.getView().byId("invoiceAmtId").getValue();var a=this.getView().byId("unplannedAmtId").getValue();a=Math.abs(parseFloat(a));a=a?a:0;var r=+t+ +a;var n=r;this.getView().byId("invoiceValueId").setValue(n.toFixed(2));this.getView().byId("AsnObjectId").setNumber(n.toFixed(2))},onEditPress:function(e){this.byId("invoiceValueId").setEditable(true)},onDelete:function(e){this.DeleteFlag=true;this.path=e.getSource().getBindingContext("asnModel").getPath().slice(-1);this.DeleteArray.push(this.asnModel.getData().asnheadertoasnitemnav.results[this.path]);this.asnModel.getData().asnheadertoasnitemnav.results.splice(this.path,1);this.asnModel.refresh();this.asnModel.getData().InvoiceVal="";this.draftInvoiceAmt()},draftInvoiceAmt:function(e){const a=e.getParameter("newValue"),r=e.getSource().getParent().getBindingContext("asnModel").getObject();if(e){var n=r.Meins;if(n=="EA"){if(a.includes(".")){t.error("Fractional Values are not allowed");e.getSource().setValue(parseInt(a,10).toString());return}}}var o=this.asnModel.getData();o.InvoiceAmt=0;var s=this.getView().byId("AsnCreateTable");var i=s.getSelectedContexts();if(i.length){var l=i.map(function(e){return e.getObject()});for(var d=0;d<l.length;d++){var u=parseFloat(l[d].Draft_AsnQty);if(u<0||l[d].Draft_AsnQty.includes("-")){sap.m.MessageBox.error("Quantity can't be in negative.");sap.ui.core.BusyIndicator.hide();return}if(!l[d].Draft_AsnQty){sap.m.MessageBox.error("Please enter a valid Quantity for selected items");o.InvoiceAmt=0;break}var c=(parseFloat(l[d].Draft_AsnQty)*parseFloat(l[d].Netpr)).toFixed(2);var h=(parseFloat(l[d].Draft_AsnQty)*parseFloat(l[d].Cgst)).toFixed(2);var g=(parseFloat(l[d].Draft_AsnQty)*parseFloat(l[d].Igst)).toFixed(2);var p=(parseFloat(l[d].Draft_AsnQty)*parseFloat(l[d].Sgst)).toFixed(2);o.InvoiceAmt=parseFloat(o.InvoiceAmt)+parseFloat(c)+parseFloat(h)+parseFloat(g)+parseFloat(p);o.InvoiceAmt=o.InvoiceAmt.toFixed(2);o.InvoiceAmt=Math.round(o.InvoiceAmt);var m=+this.asnModel.getData().InvoiceAmt+ +this.asnModel.getData().UnplannedCost;m=Math.round(m);this.asnModel.getData().InvoiceVal=m.toFixed(2);this.getView().byId("AsnObjectId").setNumber(this.asnModel.getData().InvoiceVal)}}const v=parseFloat(a)/parseFloat(r.SOQ);r.PkgMatQty=isNaN(v)?"0":isFinite(v)===false?"0":Math.ceil(v).toString();this.asnModel.refresh()},onUndo:function(e){var t=this;this.DeleteFlag=false;if(this.DeleteArray){this.DeleteArray.forEach(function(e,a){t.asnModel.getData().asnheadertoasnitemnav.results.unshift(e)});t.asnModel.refresh();t.DeleteArray=[];t.draftInvoiceAmt()}},onLinkPress:function(e){var a=this;var r=e.getSource().getParent().getBindingContext("asnModel").getObject();if(!this._oPopoverFragment){this._oPopoverFragment=sap.ui.xmlfragment("sp.fiori.purchaseorder.fragment.DatePopoverFragment",this);this._oPopoverFragment.setModel(this.dateConfirmationModel);this.getView().addDependent(this._oPopoverFragment)}this.oDataModel.read("/ConfirmationDateSet?$filter=Ebeln eq '"+r.Po_No+"'and Ebelp  eq '"+r.Ebelp+"'",null,null,false,function(e,t){a.dateConfirmationModel.setData(e);a.dateConfirmationModel.refresh(true)},function(e){var a=JSON.parse(e.response.body);t.error(a.error.message.value)});this._oPopoverFragment.openBy(e.getSource())},onTypeMissmatch:function(e){t.error("Only PDF files are allowed.")}})});